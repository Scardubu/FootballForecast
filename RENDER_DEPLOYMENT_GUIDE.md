# 🚀 Render Deployment Guide - Football Forecast

**Status:** Ready to Deploy  
**API Key:** `rnd_QTYxc8BlcCDyoaeWFpurddfXiUGi`

---

## Quick Deploy

### **Option 1: Automated Deployment (Recommended)**

```bash
# Deploy using the automated script
npm run deploy:render
```

This will automatically:
- ✅ Create PostgreSQL database
- ✅ Deploy Python ML service (Docker)
- ✅ Deploy Node.js backend + frontend
- ✅ Configure all environment variables
- ✅ Set up service connections

### **Option 2: Manual Blueprint Deploy**

1. **Push to GitHub:**
   ```bash
   git add .
   git commit -m "Ready for Render deployment"
   git push origin main
   ```

2. **Deploy via Render Dashboard:**
   - Go to: https://dashboard.render.com
   - Click **"New +"** → **"Blueprint"**
   - Connect your GitHub repository
   - Select the repository
   - Render will detect `render.yaml` automatically
   - Click **"Apply"**

---

## Architecture on Render

```
┌─────────────────────────────────────────┐
│  Web Service (Node.js)                  │
│  football-forecast-web                  │
│  Port: 10000                            │
│  URL: https://football-forecast-web     │
│       .onrender.com                     │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│  ML Service (Python Docker)             │
│  football-forecast-ml                   │
│  Port: 8000                             │
│  URL: https://football-forecast-ml      │
│       .onrender.com                     │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│  PostgreSQL Database                    │
│  football-forecast-db                   │
│  Database: football_forecast            │
└─────────────────────────────────────────┘
```

---

## Services Configuration

### **1. Web Service (Node.js)**

- **Name:** `football-forecast-web`
- **Runtime:** Node
- **Plan:** Starter ($7/month)
- **Region:** Oregon
- **Build:** `npm ci && npm run build`
- **Start:** `npm start`
- **Health Check:** `/api/health`

**Environment Variables:**
```env
NODE_ENV=production
PORT=10000
ML_SERVICE_URL=<auto-linked-from-ml-service>
DATABASE_URL=<auto-linked-from-database>
SESSION_SECRET=<auto-generated>
DISABLE_DATABASE_STORAGE=false
ML_FALLBACK_ENABLED=true
```

### **2. ML Service (Python)**

- **Name:** `football-forecast-ml`
- **Runtime:** Docker
- **Plan:** Starter ($7/month)
- **Region:** Oregon
- **Dockerfile:** `./Dockerfile.python`
- **Health Check:** `/`

**Environment Variables:**
```env
PORT=8000
PYTHONUNBUFFERED=1
```

### **3. PostgreSQL Database**

- **Name:** `football-forecast-db`
- **Database Name:** `football_forecast`
- **Plan:** Starter ($7/month)
- **Region:** Oregon

---

## Deployment Steps

### **Step 1: Prepare Repository**

Ensure these files are in your repository:
- ✅ `render.yaml` - Blueprint configuration
- ✅ `Dockerfile.python` - ML service Docker image
- ✅ `package.json` - Node.js dependencies
- ✅ `pyproject.toml` - Python dependencies

### **Step 2: Deploy**

**Using Automated Script:**
```bash
npm run deploy:render
```

**Or Manually:**
```bash
# Set API key
export RENDER_API_KEY=rnd_QTYxc8BlcCDyoaeWFpurddfXiUGi

# Run deployment script
node deploy-render.js
```

### **Step 3: Wait for Build**

- **Database:** ~2 minutes (creates immediately)
- **ML Service:** ~5-8 minutes (Docker build)
- **Web Service:** ~3-5 minutes (npm install + build)

**Total Time:** ~10-15 minutes

### **Step 4: Run Database Migrations**

Once the database is created:

```bash
# Get DATABASE_URL from Render dashboard
DATABASE_URL="<your-connection-string>" npm run db:push
```

Or from Render dashboard:
1. Go to your database service
2. Click **"Connect"** → **"External Connection"**
3. Copy the connection string
4. Run migrations locally

### **Step 5: Verify Deployment**

```bash
# Check web service
curl https://football-forecast-web.onrender.com/api/health

# Check ML service
curl https://football-forecast-ml.onrender.com/

# Check ML model status
curl https://football-forecast-ml.onrender.com/model/status
```

---

## Post-Deployment Configuration

### **Optional: Add Custom Domain**

1. Go to Web Service settings
2. Click **"Custom Domains"**
3. Add your domain
4. Update DNS records as instructed

### **Optional: Environment Variables**

Add these optional variables in Render dashboard:

```env
# API Football (for live data)
API_FOOTBALL_KEY=<your-api-key>

# Additional security
CORS_ORIGINS=https://yourdomain.com

# Monitoring
LOG_LEVEL=info
```

---

## Monitoring & Logs

### **View Logs**

**Web Service:**
```bash
# Via Render Dashboard
Dashboard → football-forecast-web → Logs

# Via CLI (if installed)
render logs -s football-forecast-web
```

**ML Service:**
```bash
# Via Render Dashboard
Dashboard → football-forecast-ml → Logs
```

### **Health Checks**

Render automatically monitors:
- Web Service: `GET /api/health` every 30s
- ML Service: `GET /` every 30s

If health checks fail 3 times, Render will restart the service.

### **Metrics**

View in Render Dashboard:
- CPU usage
- Memory usage
- Request count
- Response times
- Error rates

---

## Troubleshooting

### **Issue: Build Fails**

**Web Service Build Errors:**
```bash
# Check Node.js version
node --version  # Should be >= 18.18.0

# Clear cache and rebuild
# In Render: Manual Deploy → Clear build cache
```

**ML Service Build Errors:**
```bash
# Check Dockerfile.python
# Ensure all dependencies in pyproject.toml

# Test locally:
docker build -f Dockerfile.python -t ml-test .
docker run -p 8000:8000 ml-test
```

### **Issue: Service Won't Start**

**Check Environment Variables:**
- Ensure `PORT` is set correctly
- Verify `ML_SERVICE_URL` points to ML service
- Check `DATABASE_URL` is valid

**Check Logs:**
- Look for startup errors in Render logs
- Common issues: missing dependencies, port conflicts

### **Issue: Database Connection Fails**

```bash
# Verify DATABASE_URL format
postgresql://user:password@host:port/database

# Test connection locally
psql $DATABASE_URL

# Check if migrations ran
DATABASE_URL="<url>" npm run db:push
```

### **Issue: ML Service Unreachable**

```bash
# Check ML service is running
curl https://football-forecast-ml.onrender.com/

# Verify ML_SERVICE_URL in web service
# Should be: https://football-forecast-ml.onrender.com

# Check Docker build logs
```

---

## Costs

### **Monthly Pricing (Starter Plans)**

| Service | Plan | Cost |
|---------|------|------|
| Web Service (Node.js) | Starter | $7/month |
| ML Service (Docker) | Starter | $7/month |
| PostgreSQL Database | Starter | $7/month |
| **Total** | | **$21/month** |

### **Free Tier Alternative**

Render offers free tier with limitations:
- Services spin down after 15 minutes of inactivity
- 750 hours/month free compute
- Slower cold starts

To use free tier, change `plan: starter` to `plan: free` in `render.yaml`

---

## Scaling

### **Horizontal Scaling**

Upgrade to higher plans for:
- More CPU/RAM
- Multiple instances
- Auto-scaling
- No cold starts

### **Vertical Scaling**

Available plans:
- **Starter:** 0.5 CPU, 512 MB RAM
- **Standard:** 1 CPU, 2 GB RAM
- **Pro:** 2 CPU, 4 GB RAM
- **Pro Plus:** 4 CPU, 8 GB RAM

---

## Rollback

### **Rollback to Previous Deploy**

1. Go to Render Dashboard
2. Select service
3. Click **"Deploys"** tab
4. Find previous successful deploy
5. Click **"Rollback"**

### **Rollback via API**

```bash
curl -X POST \
  https://api.render.com/v1/services/<service-id>/deploys/<deploy-id>/rollback \
  -H "Authorization: Bearer rnd_QTYxc8BlcCDyoaeWFpurddfXiUGi"
```

---

## Maintenance

### **Update Dependencies**

```bash
# Update Node.js dependencies
npm update

# Update Python dependencies
uv pip compile pyproject.toml

# Commit and push
git add .
git commit -m "Update dependencies"
git push

# Render will auto-deploy
```

### **Database Backups**

Render automatically backs up PostgreSQL:
- Daily backups retained for 7 days
- Manual backups available in dashboard

### **Manual Backup:**

```bash
# Export database
pg_dump $DATABASE_URL > backup.sql

# Import database
psql $DATABASE_URL < backup.sql
```

---

## CI/CD Integration

### **Automatic Deploys**

Render automatically deploys on:
- Push to `main` branch (if `autoDeploy: true`)
- Manual trigger in dashboard
- API trigger

### **Disable Auto-Deploy**

In `render.yaml`, set:
```yaml
autoDeploy: false
```

### **Deploy Hooks**

Get deploy hook URL from Render dashboard:
```bash
curl -X POST https://api.render.com/deploy/srv-xxxxx?key=xxxxx
```

---

## Security Best Practices

### **Environment Variables**

✅ **DO:**
- Use Render's secret management
- Rotate `SESSION_SECRET` regularly
- Use `generateValue: true` for secrets

❌ **DON'T:**
- Commit secrets to Git
- Share API keys publicly
- Use weak passwords

### **Database Security**

- Enable SSL connections (default on Render)
- Use strong passwords
- Limit external access
- Regular backups

### **API Security**

- Enable rate limiting (already configured)
- Use CORS properly
- Validate all inputs
- Monitor for suspicious activity

---

## Support

### **Render Support**

- **Dashboard:** https://dashboard.render.com
- **Docs:** https://render.com/docs
- **Community:** https://community.render.com
- **Status:** https://status.render.com

### **Application Support**

- **GitHub Issues:** Create issue in repository
- **Documentation:** See `/docs` folder
- **Health Checks:** Monitor `/api/health`

---

## Quick Reference

### **Important URLs**

```bash
# Render Dashboard
https://dashboard.render.com

# Web Service
https://football-forecast-web.onrender.com

# ML Service
https://football-forecast-ml.onrender.com

# API Health
https://football-forecast-web.onrender.com/api/health

# ML Health
https://football-forecast-ml.onrender.com/
```

### **Common Commands**

```bash
# Deploy
npm run deploy:render

# Check logs
# (via Render Dashboard)

# Run migrations
DATABASE_URL="<url>" npm run db:push

# Test integration
npm run test:integration

# Build locally
npm run build
```

---

## Next Steps After Deployment

1. ✅ **Verify Services Running**
   - Check health endpoints
   - View logs for errors
   - Test API endpoints

2. ✅ **Run Database Migrations**
   - Connect to database
   - Run `npm run db:push`
   - Verify tables created

3. ✅ **Test ML Predictions**
   - Call `/api/ml/predict`
   - Verify XGBoost model loads
   - Check prediction quality

4. ✅ **Configure Monitoring**
   - Set up uptime monitoring
   - Configure alerts
   - Monitor error rates

5. ✅ **Optional Enhancements**
   - Add custom domain
   - Enable CDN
   - Configure auto-scaling
   - Set up staging environment

---

**Deployment Ready! 🚀**

Run `npm run deploy:render` to start deployment.
